<html>
<head>
    <meta name="csrf_token" content="{{ csrf_token() }}" />
    <meta name="authenticated_user" content="{{ current_user.username }}" />
    <link rel='stylesheet' type='text/css' href='static/fullcalendar/fullcalendar.css' />
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type='text/javascript' src='static/fullcalendar/fullcalendar.js'></script>
    
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.min.css" />
    <link rel="stylesheet" href="static/site_style.css" />
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>


    <script>
        function custom_post(url, data, other_options)
            {
            var csrftoken = $('meta[name=csrf_token]').attr('content')
            options=
                {
                type: "POST",
                url: url,
                data: data,
                beforeSend: function(xhr, settings) 
                    {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken)
                    }
                }
            options= $.extend(options, other_options)
            $.ajax(options)
            }
        
        function post_or_fail(url, data)
            {
            options={
                error: function()
                    {
                    alert('An error occurred while sending data to the server. The page will be refreshed')
                    location.reload()
                    }
                }
            custom_post(url, data, options)
            }
        
        function get_authenticated_user()
            {
            return $('meta[name=authenticated_user]').attr('content')
            }
            
        function delete_user_events_in_date(date, callback)
            {
            deleted_any= false
            user= get_authenticated_user()
            function shall_delete(event)
                {
                same_date= (String(event.start)==String(date))
                same_user= (event.title==user)
                del= (same_date && same_user)
                if (del)
                    {
                    deleted_any=true
                    callback(event)
                    }
                return del
                }
            $('#calendar').fullCalendar( 'removeEvents', shall_delete)
            return deleted_any
            }

        function remote_event_delete( event )
                {
                date_string= $.fullCalendar.formatDate( event.start, 'u') //ISO8601
                post_or_fail('events', {date:date_string, delete:true})
                }
                
        function click_day(date, allDay, jsEvent, view) 
            {
            deleted_any= delete_user_events_in_date(date, remote_event_delete)
            if (!deleted_any)
                {
                newevent= {title: get_authenticated_user(), start: date, color: "#aa0000"}
                date_string= $.fullCalendar.formatDate( date, 'u') //ISO8601
                post_or_fail('events', {date:date_string})
                $('#calendar').fullCalendar('renderEvent', newevent)
                }
            }
        
        function click_event(event)
            {
            delete_user_events_in_date(event.start, remote_event_delete)
            }
    
        $(document).ready(
            function() 
                {
                $( "#show-login-button" ).button()
                $( "#show-login-button" ).click(show_login_dialog)
                $('#calendar').fullCalendar(
                    {
                    dayClick: click_day,
                    eventClick: click_event,
                    events: '/events' //json url
                    }
                    )
                }
            );
    </script>
</head>
<body>
    <h1>Collab employee vacations</h1>
    {% if current_user.is_authenticated() %}
    <h3>{{current_user.username}}</h3>
    {% else %}
    <input id="show-login-button" type=button value="Login"/>
    <br/><br/>
    {% endif %}
     
    <div id='calendar'></div>
    {% include 'login-dialog.html' %}
</body>
</html>
